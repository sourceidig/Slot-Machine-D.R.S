{% extends 'base.html' %}

{% block title %}Máquinas - Slot Machine D.R.S.{% endblock %}
{% block page_title %}Gestión de Máquinas{% endblock %}

{% block content %}
<div class="card">
  <div class="card-header">
    <div class="d-flex justify-content-between align-items-center">
      <h5 class="mb-0"><i class="bi bi-cpu"></i> Máquinas</h5>
      <a href="{% url 'control:maquina_create' %}" class="btn btn-primary">
        <i class="bi bi-plus-circle"></i> Nueva Máquina
      </a>
    </div>
  </div>

  <div class="card-body">

    <!-- Filtros -->
    <form method="get" class="row g-2 align-items-end mb-3">
      <div class="col-12 col-md-5">
        <label class="form-label mb-1">Sucursal</label>
        <select name="sucursal" class="form-select" onchange="this.form.submit()">
          <option value="">Todas</option>
          {% for s in sucursales %}
            <option value="{{ s.id }}"
              {% if s.id|stringformat:"s" == sucursal_id %}selected{% endif %}>
              {{ s.nombre }}
            </option>
          {% endfor %}
        </select>
      </div>

      <div class="col-12 col-md-5">
        <label class="form-label mb-1">Zona</label>
        <select name="zona" class="form-select" onchange="this.form.submit()">
          <option value="">Todas</option>

          {# Si hay sucursal seleccionada, mostrar zonas de esa sucursal #}
          {% if sucursal_id %}
            {% for z in zonas %}
              {% if z.sucursal_id|stringformat:"s" == sucursal_id %}
                <option value="{{ z.id }}"
                  {% if z.id|stringformat:"s" == zona_id %}selected{% endif %}>
                  {{ z.nombre }}
                </option>
              {% endif %}
            {% endfor %}
          {% else %}
            {# Si no hay sucursal seleccionada, mostrar todas las zonas activas #}
            {% for z in zonas %}
              <option value="{{ z.id }}"
                {% if z.id|stringformat:"s" == zona_id %}selected{% endif %}>
                {{ z.sucursal.nombre }} - {{ z.nombre }}
              </option>
            {% endfor %}
          {% endif %}
        </select>
      </div>

      <div class="col-12 col-md-2 d-grid">
        <a href="{% url 'control:maquinas_list' %}" class="btn btn-outline-secondary">
          Limpiar
        </a>
      </div>
    </form>

    <!-- Tabla -->
    <div class="table-responsive">
      <table class="table table-striped table-hover align-middle">
        <thead class="table-dark">
          <tr>
            <th>Nº</th>
            <th>Juego</th>
            <th>Sucursal</th>
            <th>Zona</th>
            <th>Modelo</th>
            <th style="min-width: 260px;">Estado</th>
            <th width="150">Acciones</th>
          
          </tr>
        </thead>
        <tbody>
          {% for maquina in maquinas %}
            <tr>
              <td><strong>M{{ maquina.numero_maquina|stringformat:"02d" }}</strong></td>
              <td>{{ maquina.nombre_juego }}</td>
              <td>{{ maquina.sucursal.nombre }}</td>
              <td>{{ maquina.zona.nombre }}</td>
              <td>{{ maquina.modelo|default:"-" }}</td>

              <!-- Estado editable desde la tabla -->
              <td>
                <form method="post"
                      action="{% url 'control:maquina_estado' maquina.id %}"
                      class="d-flex gap-2">
                  {% csrf_token %}
                  <select name="estado" class="form-select form-select-sm" style="max-width: 190px;">
                    {% for val, label in maquina.ESTADO_CHOICES %}
                      <option value="{{ val }}" {% if maquina.estado == val %}selected{% endif %}>
                        {{ label }}
                      </option>
                    {% endfor %}
                  </select>
                  <button class="btn btn-sm btn-primary" type="submit">Guardar</button>
                </form>
              </td>

              <td>
                <a href="{% url 'control:maquina_edit' maquina.pk %}" class="btn btn-sm btn-warning" title="Editar">
                  <i class="bi bi-pencil"></i>
                </a>
                <a href="{% url 'control:maquina_delete' maquina.pk %}" class="btn btn-sm btn-danger" title="Eliminar">
                  <i class="bi bi-trash"></i>
                </a>
              </td>
            </tr>
          {% empty %}
            <tr>
              <td colspan="7" class="text-center text-muted">No hay máquinas registradas</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

  </div>
</div>
{% endblock %}
