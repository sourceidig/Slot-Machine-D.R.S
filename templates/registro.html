{% extends 'base.html' %}
{% load static %}

{% block title %}Registro - Slot Machine D.R.S.{% endblock %}
{% block page_title %}Registro de Lecturas{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8 mx-auto">
        
        {% if not turno_abierto %}
            <div class="alert alert-warning">
                <i class="bi bi-exclamation-triangle"></i>
                <strong>No hay turno abierto.</strong>
                Debe iniciar un turno en la pesta침a <a href="{% url 'control:turno' %}" class="alert-link">"Turno"</a> antes de registrar lecturas.
            </div>
        {% else %}
            <!-- Informaci칩n del Contexto -->
            <div class="card mb-3">
                <div class="card-header bg-info text-white">
                    <h6 class="mb-0"><i class="bi bi-info-circle"></i> Contexto del Turno</h6>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <small class="text-muted">Sucursal</small>
                            <p class="mb-0">{{ turno_abierto.sucursal.nombre }}</p>
                        </div>
                        <!-- Eliminada zona del contexto del turno -->
                        <div class="col-md-4">
                            <small class="text-muted">Fecha</small>
                            <p class="mb-0">{{ turno_abierto.fecha|date:"d/m/Y" }}</p>
                        </div>
                        <div class="col-md-4">
                            <small class="text-muted">Turno</small>
                            <p class="mb-0">{{ turno_abierto.tipo_turno }}</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Formulario de Lectura -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-clipboard-data"></i> Registrar Lectura de M치quina</h5>
                </div>
                <div class="card-body">
                    <form method="post" id="lecturaForm">
                        {% csrf_token %}
                        
                        <!-- Secci칩n: Selecci칩n de Zona y M치quina -->
                        <h6 class="mb-3 text-primary">Datos de la M치quina</h6>
                        
                        <!-- Agregado campo de zona antes de m치quina -->
                        <div class="mb-3">
                            <label for="id_zona" class="form-label">Zona</label>
                            {{ form.zona }}
                        </div>
                        
                        <div class="mb-3">
                            <label for="id_maquina" class="form-label">Seleccionar M치quina</label>
                            {{ form.maquina }}
                        </div>
                        
                        <div id="maquinaInfo" class="mb-4" style="display: none;">
                            <div class="row">
                                <div class="col-md-6">
                                    <label class="form-label">N칰mero de M치quina</label>
                                    <input type="text" id="numeroMaquina" class="form-control" readonly>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Juego</label>
                                    <input type="text" id="nombreJuego" class="form-control" readonly>
                                </div>
                            </div>
                        </div>
                        
                        <hr>
                        
                        <!-- Secci칩n: Datos de Lectura -->
                        <h6 class="mb-3 text-primary">Datos de Lectura</h6>
                        
                        <div class="mb-3">
                            <label for="id_entrada" class="form-label">Entrada</label>
                            {{ form.entrada }}
                        </div>
                        
                        <div class="mb-3">
                            <label for="id_salida" class="form-label">Salida</label>
                            {{ form.salida }}
                        </div>
                        
                        <div class="mb-3">
                            <label for="id_total" class="form-label">Total (Entrada - Salida)</label>
                            {{ form.total }}
                        </div>
                        
                        <div class="mb-4">
                            <label for="id_nota" class="form-label">Nota (Opcional)</label>
                            {{ form.nota }}
                        </div>
                        
                        <!-- Nuevo bot칩n de Captura con C치mara -->
                        <div class="d-grid gap-2 mb-3">
                            <button type="button" class="btn btn-primary btn-lg-tablet" id="btnCapturarCamara">
                                <i class="bi bi-camera-fill"></i> Capturar con C치mara
                            </button>
                            <small class="text-muted text-center">
                                <i class="bi bi-info-circle"></i> Abre la c치mara para escanear la pantalla de la m치quina
                            </small>
                        </div>
                        
                        <!-- Bot칩n IA Dummy (mantener por compatibilidad) -->
                      <!--  <div class="d-grid gap-2 mb-3">
                            <button type="button" class="btn btn-warning btn-lg-tablet" id="btnIA">
                                <i class="bi bi-robot"></i> Simulaci칩n IA (Datos Dummy)
                            </button>
                            <small class="text-muted text-center">
                                <i class="bi bi-info-circle"></i> Genera datos de prueba
                            </small>
                        </div>-->
                        
                        <hr>
                        
                        <!-- Bot칩n Guardar -->
                        <div class="d-grid">
                            <button type="submit" class="btn btn-success btn-lg-tablet">
                                <i class="bi bi-save"></i> Guardar Lectura
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        {% endif %}
        
    </div>
</div>

<!-- Modal de Captura de C치mara -->
<div class="modal fade" id="cameraModal" tabindex="-1" aria-labelledby="cameraModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="cameraModalLabel">
                    <i class="bi bi-camera-video"></i> Capturar Pantalla de M치quina
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="text-center">
                    <!-- Vista previa de la c치mara -->
                    <video id="video" autoplay playsinline style="width: 100%; max-width: 640px; display: none;"></video>
                    
                    <!-- Canvas para capturar la foto -->
                    <canvas id="canvas" style="display: none;"></canvas>
                    
                    <!-- Imagen capturada -->
                    <img id="capturedImage" style="width: 100%; max-width: 640px; display: none;" />
                    
                    <!-- Spinner de procesamiento -->
                    <div id="processingSpinner" style="display: none;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Procesando...</span>
                        </div>
                        <p class="mt-3">Procesando...</p>
                    </div>
                    
                    <!-- Mensaje de estado -->
                    <div id="cameraStatus" class="alert alert-info mt-3" style="display: none;"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="btnCerrarModal">
                    Cerrar
                </button>
                <button type="button" class="btn btn-success" id="btnTomarFoto">
                    <i class="bi bi-camera"></i> Tomar Foto
                </button>
                <button type="button" class="btn btn-primary" id="btnProcesarFoto" style="display: none;">
                    <i class="bi bi-check-circle"></i> Procesar
                </button>
                <button type="button" class="btn btn-warning" id="btnRetomar" style="display: none;">
                    <i class="bi bi-arrow-clockwise"></i> Tomar Otra
                </button>
            </div>
        </div>
    </div>
</div>

{% block extra_js %}
<script src="{% static 'js/ocr_capturas.js' %}"></script>
{% endblock %}

<script>
    document.addEventListener('DOMContentLoaded', function () {
    // id de la zona guardada en sesi칩n (puede venir vac칤o)
    const zonaGuardada = "{{ zona_guardada|default:'' }}";
    const zonaSelect = document.getElementById('id_zona');

    if (zonaGuardada && zonaSelect) {
        // El formulario ya viene con la opci칩n seleccionada, pero por si acaso:
        zonaSelect.value = zonaGuardada;

        // 游녤 Disparar el "change" para que tu JS de zonas/maquinas cargue las m치quinas
        const eventoChange = new Event('change');
        zonaSelect.dispatchEvent(eventoChange);
    }
    });
    document.getElementById('id_zona').addEventListener('change', function() {
        const zonaId = this.value;
        const maquinaSelect = document.getElementById('id_maquina');
        
        if (zonaId) {
            fetch(`/api/maquinas/${zonaId}/`)
                .then(response => response.json())
                .then(data => {
                    maquinaSelect.innerHTML = '<option value="">---------</option>';
                    data.forEach(maquina => {
                        const option = document.createElement('option');
                        option.value = maquina.id;
                        option.textContent = `M${maquina.numero_maquina} - ${maquina.nombre_juego}`;
                        maquinaSelect.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error('Error al cargar m치quinas:', error);
                    alert('Error al cargar las m치quinas');
                });
        } else {
            maquinaSelect.innerHTML = '<option value="">---------</option>';
        }
    });
    
    // Mostrar info de m치quina al seleccionar
    document.getElementById('id_maquina').addEventListener('change', function() {
        const maquinaSelect = this;
        const selectedOption = maquinaSelect.options[maquinaSelect.selectedIndex];
        
        if (maquinaSelect.value) {
            const maquinaText = selectedOption.text;
            const parts = maquinaText.split(' - ');
            
            if (parts.length >= 2) {
                const numero = parts[0].replace('M', '');
                const juego = parts[1];
                
                document.getElementById('numeroMaquina').value = numero;
                document.getElementById('nombreJuego').value = juego;
                document.getElementById('maquinaInfo').style.display = 'block';
            }
        } else {
            document.getElementById('maquinaInfo').style.display = 'none';
        }
    });
    
    // Calcular total autom치ticamente
    function calcularTotal() {
        const entrada = parseInt(document.getElementById('id_entrada').value) || 0;
        const salida = parseInt(document.getElementById('id_salida').value) || 0;
        const total = entrada - salida;
        document.getElementById('id_total').value = total;
    }
    
    document.getElementById('id_entrada').addEventListener('input', calcularTotal);
    document.getElementById('id_salida').addEventListener('input', calcularTotal);
    
    // Bot칩n IA Dummy (mantener por compatibilidad)
    document.getElementById('btnIA').addEventListener('click', function() {
        this.disabled = true;
        this.innerHTML = '<i class="bi bi-hourglass-split"></i> Generando datos...';
        
        fetch('/api/ia/dummy/')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('id_entrada').value = data.entrada;
                    document.getElementById('id_salida').value = data.salida;
                    document.getElementById('id_total').value = data.total;
                    
                    alert(data.mensaje);
                }
            })
            .catch(error => {
                alert('Error al generar datos: ' + error);
            })
            .finally(() => {
                this.disabled = false;
                this.innerHTML = '<i class="bi bi-robot"></i> Simulaci칩n IA (Datos Dummy)';
            });
    });//
    
    // Bot칩n Capturar con C치mara
    document.getElementById('btnCapturarCamara').addEventListener('click', function() {
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const capturedImage = document.getElementById('capturedImage');
        const processingSpinner = document.getElementById('processingSpinner');
        const cameraStatus = document.getElementById('cameraStatus');
        const btnTomarFoto = document.getElementById('btnTomarFoto');
        const btnProcesarFoto = document.getElementById('btnProcesarFoto');
        const btnRetomar = document.getElementById('btnRetomar');
        
        navigator.mediaDevices.getUserMedia({ video: true })
            .then(stream => {
                video.srcObject = stream;
                video.style.display = 'block';
                btnTomarFoto.style.display = 'block';
            })
            .catch(error => {
                console.error('Error al acceder a la c치mara:', error);
                alert('Error al acceder a la c치mara');
            });
    });
    
    // Bot칩n Tomar Foto
    document.getElementById('btnTomarFoto').addEventListener('click', function() {
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const capturedImage = document.getElementById('capturedImage');
        const btnTomarFoto = document.getElementById('btnTomarFoto');
        const btnProcesarFoto = document.getElementById('btnProcesarFoto');
        
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        const context = canvas.getContext('2d');
        context.drawImage(video, 0, 0, canvas.width, canvas.height);
        
        capturedImage.src = canvas.toDataURL('image/png');
        capturedImage.style.display = 'block';
        video.style.display = 'none';
        btnTomarFoto.style.display = 'none';
        btnProcesarFoto.style.display = 'block';
    });
    
    // Bot칩n Procesar Foto
    document.getElementById('btnProcesarFoto').addEventListener('click', function() {
        const capturedImage = document.getElementById('capturedImage');
        const processingSpinner = document.getElementById('processingSpinner');
        const cameraStatus = document.getElementById('cameraStatus');
        const btnProcesarFoto = document.getElementById('btnProcesarFoto');
        const btnRetomar = document.getElementById('btnRetomar');
        
        processingSpinner.style.display = 'block';
        cameraStatus.style.display = 'none';
        btnProcesarFoto.style.display = 'none';
        btnRetomar.style.display = 'none';
        
        fetch('/api/ocr/procesar/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ image: capturedImage.src })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('id_entrada').value = data.entrada;
                    document.getElementById('id_salida').value = data.salida;
                    document.getElementById('id_total').value = data.total;
                    
                    cameraStatus.textContent = data.mensaje;
                    cameraStatus.style.display = 'block';
                } else {
                    cameraStatus.textContent = data.error;
                    cameraStatus.style.display = 'block';
                }
            })
            .catch(error => {
                console.error('Error al procesar imagen:', error);
                alert('Error al procesar la imagen');
            })
            .finally(() => {
                processingSpinner.style.display = 'none';
                btnRetomar.style.display = 'block';
            });
    });
    
    // Bot칩n Retomar
    document.getElementById('btnRetomar').addEventListener('click', function() {
        const video = document.getElementById('video');
        const capturedImage = document.getElementById('capturedImage');
        const processingSpinner = document.getElementById('processingSpinner');
        const cameraStatus = document.getElementById('cameraStatus');
        const btnTomarFoto = document.getElementById('btnTomarFoto');
        const btnProcesarFoto = document.getElementById('btnProcesarFoto');
        const btnRetomar = document.getElementById('btnRetomar');
        
        video.style.display = 'block';
        capturedImage.style.display = 'none';
        processingSpinner.style.display = 'none';
        cameraStatus.style.display = 'none';
        btnTomarFoto.style.display = 'block';
        btnProcesarFoto.style.display = 'none';
        btnRetomar.style.display = 'none';
    });
</script>
{% endblock %}
