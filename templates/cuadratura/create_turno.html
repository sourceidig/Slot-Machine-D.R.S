{% extends 'base.html' %}

{% block page_title %}Cuadratura de Turno{% endblock %}

{% block content %}
<div class="card">
  <div class="card-header bg-primary text-white">
    <h5 class="mb-0">
      <i class="bi bi-calculator"></i>
      Cuadratura de Caja - Turno
    </h5>
    <small>
      {{ turno.sucursal.nombre }} |
      {{ turno.fecha|date:"d/m/Y" }} |
      {{ turno.tipo_turno }} |
      {{ turno.usuario.nombre }}
    </small>
  </div>

  <div class="card-body pb-0">
    <div class="row g-2 mb-3">
      <div class="col-md-3">
        <label class="form-label fw-bold">Usuario</label>
        <input class="form-control" value="{{ turno.usuario.nombre }}" readonly>
      </div>
      <div class="col-md-3">
        <label class="form-label fw-bold">Sucursal</label>
        <input class="form-control" value="{{ turno.sucursal.nombre }}" readonly>
      </div>
      <div class="col-md-3">
        <label class="form-label fw-bold">Fecha</label>
        <input class="form-control" value="{{ turno.fecha|date:'d/m/Y' }}" readonly>
      </div>
      <div class="col-md-3">
        <label class="form-label fw-bold">Turno</label>
        <input class="form-control" value="{{ turno.tipo_turno }}" readonly>
      </div>
    </div>
  </div>

  <div class="card-body pt-0">
    <form method="post" id="formCuadratura">
      {% csrf_token %}

      {{ zonas_fs.management_form }}

      {% for block in zona_blocks %}
        <div class="border rounded mb-3 p-2">
          <div class="bg-light px-2 py-2 border-bottom fw-bold">
            ZONA: {{ block.zona.nombre }}
          </div>

          <div class="table-responsive mt-2">
            <table class="table table-sm table-bordered align-middle mb-0">
              <thead class="table-light">
                <tr>
                  <th>N° Máquina</th>
                  <th>Juego</th>
                  <th class="text-end">Entrada</th>
                  <th class="text-end">Salida</th>
                  <th class="text-end">Total</th>
                </tr>
              </thead>
              <tbody>
                {% for l in block.lecturas %}
                  <tr>
                    <td>{{ l.numero_maquina }}</td>
                    <td>{{ l.nombre_juego }}</td>
                    <td class="text-end">{{ l.entrada }}</td>
                    <td class="text-end">{{ l.salida }}</td>
                    <td class="text-end">{{ l.total }}</td>
                  </tr>
                {% empty %}
                  <tr>
                    <td colspan="5" class="text-muted">Sin lecturas en esta zona</td>
                  </tr>
                {% endfor %}
                <tr class="table-light fw-bold">
                  <td colspan="4" class="text-end">TOTAL ZONA (lecturas):</td>
                  <td class="text-end">{{ block.total_zona }}</td>
                </tr>
              </tbody>
            </table>
          </div>

          {% if block.fz %}
            {{ block.fz.id }}
            {{ block.fz.zona }}

            <div class="row g-2 mt-2">
              <div class="col-md-6">
                <label class="form-label fw-bold">NUMERAL</label>
                {{ block.fz.numeral }}
              </div>
              <div class="col-md-6">
                <label class="form-label fw-bold">CAJA</label>
                {{ block.fz.caja }}
              </div>

              <div class="col-md-6">
                <label class="form-label fw-bold">PRÉSTAMOS</label>
                {{ block.fz.prestamos }}
              </div>
              <div class="col-md-6">
                <label class="form-label fw-bold">REDBANK</label>
                {{ block.fz.redbank }}
              </div>

              <div class="col-md-6">
                <label class="form-label fw-bold">RETIROS</label>
                {{ block.fz.retiros }}
              </div>
              <hr class="my-3">

            <div class="card">
                <div class="card-header fw-bold">DETALLE ENTREGADO (MONTO)</div>
                <div class="card-body">

                    <div class="row g-2">
                    <div class="col-md-4">
                        <label class="form-label fw-bold">$20.000</label>
                        {{ block.fz.billete_20000_monto }}
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-bold">$10.000</label>
                        {{ block.fz.billete_10000_monto }}
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-bold">$5.000</label>
                        {{ block.fz.billete_5000_monto }}
                    </div>

                    <div class="col-md-4">
                        <label class="form-label fw-bold">$2.000</label>
                        {{ block.fz.billete_2000_monto }}
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-bold">$1.000</label>
                        {{ block.fz.billete_1000_monto }}
                    </div>

                    <div class="col-md-4">
                        <label class="form-label fw-bold">MONEDAS</label>
                        {{ block.fz.monedas_monto }}
                    </div>
                    </div>

                </div>
            </div>

              <div class="col-md-6">
                <label class="form-label fw-bold">DETALLE ENTREGADO (TOTAL)</label>
                {{ block.fz.detalle_entregado_total }}
              </div>
            </div>

            <div class="row g-2 mt-2">
              <div class="col-md-6">
                <div class="alert alert-info mb-0">
                  <strong>TOTAL CAJA (esperado):</strong>
                  <span class="float-end fw-bold"
                        data-total-caja
                        data-zona="{{ block.zona.id }}">0</span>
                </div>
              </div>
              <div class="col-md-6">
                <div class="alert alert-warning mb-0">
                  <strong>DESCUADRE:</strong>
                  <span class="float-end fw-bold"
                        data-descuadre
                        data-zona="{{ block.zona.id }}">0</span>
                </div>
              </div>
            </div>

          {% else %}
            <div class="alert alert-danger mt-2">
              Falta el form de esta zona en el formset (revisa _sync_cierre_zonas_activo)
            </div>
          {% endif %}
        </div>
      {% endfor %}
     <hr class="my-4">

     <div class="card mb-3">
        <div class="card-header fw-bold">DETALLE ENTREGADO (MONTO POR DENOMINACIÓN)</div>
        <div class="card-body">

            {{ den_fs.management_form }}

            <div class="table-responsive">
            <table class="table table-sm table-bordered align-middle">
                <thead class="table-light">
                <tr>
                    <th style="width:120px;">Tipo</th>
                    <th style="width:160px;" class="text-end">Denominación</th>
                    <th class="text-end">Monto ($)</th>
                </tr>
                </thead>
                <tbody>
                {% for f in den_fs %}
                    <tr>
                    <td class="text-muted">
                        {# si ocultas tipo en forms, muestra el valor así #}
                        {{ f.instance.tipo }}
                    </td>
                    <td class="text-end">{{ f.denominacion }}</td>
                    <td class="text-end">{{ f.cantidad }}</td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
            </div>

            <div class="alert alert-info mb-0">
            <strong>TOTAL EFECTIVO (contado):</strong>
            <span class="float-end fw-bold">{{ cierre.total_efectivo_contado }}</span>
            </div>

        </div>
        </div>

      <div class="mt-3">
        <label class="form-label fw-bold">Observaciones</label>
        {{ form.observaciones }}
      </div>

      <div class="mt-4 d-flex gap-2">
        <button type="submit" class="btn btn-success btn-lg">
          <i class="bi bi-check-circle"></i> Guardar Cuadratura
        </button>
        <a href="{% url 'control:turno' %}" class="btn btn-secondary btn-lg">
          <i class="bi bi-x-circle"></i> Volver
        </a>
      </div>

    </form>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function toInt(v){ v = parseInt(v,10); return isNaN(v)?0:v; }

function recalcularPorZona(){
  document.querySelectorAll('[data-total-caja]').forEach(span=>{
    const zid = span.getAttribute('data-zona');

    const numeral = document.querySelector(`input[name^="zonas-"][name$="-numeral"]`) // fallback
    // Mejor: buscamos inputs por zona mediante el hidden zona id
  });

  // Recorremos cada bloque usando el hidden zona del formset
  document.querySelectorAll('input[name$="-zona"]').forEach(zonaHidden=>{
    const zid = zonaHidden.value;
    const prefix = zonaHidden.name.replace('-zona',''); // ej: zonas-0

    const caja = toInt(document.querySelector(`input[name="${prefix}-caja"]`)?.value);
    const numeral = toInt(document.querySelector(`input[name="${prefix}-numeral"]`)?.value);
    const prestamos = toInt(document.querySelector(`input[name="${prefix}-prestamos"]`)?.value);
    const redbank = toInt(document.querySelector(`input[name="${prefix}-redbank"]`)?.value);
    const retiros = toInt(document.querySelector(`input[name="${prefix}-retiros"]`)?.value);
    const entregado = toInt(document.querySelector(`input[name="${prefix}-detalle_entregado_total"]`)?.value);

    // total esperado por zona (según tu Excel)
    const totalEsperado = caja + numeral + prestamos + redbank - retiros;
    const descuadre = entregado - totalEsperado;

    const totalSpan = document.querySelector(`[data-total-caja][data-zona="${zid}"]`);
    const descSpan = document.querySelector(`[data-descuadre][data-zona="${zid}"]`);
    if(totalSpan) totalSpan.textContent = totalEsperado;
    if(descSpan) descSpan.textContent = descuadre;
  });
}

document.addEventListener('DOMContentLoaded', ()=>{
  document.querySelectorAll('#formCuadratura input, #formCuadratura textarea').forEach(el=>{
    el.addEventListener('input', recalcularPorZona);
  });
  recalcularPorZona();
});
</script>
{% endblock %}
